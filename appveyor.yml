version: "{build}"

max_jobs: 1

image: Ubuntu2204

build: off
test: off

environment:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  NUGET_XMLDOC_MODE: "skip"

install:
  - sh: |
      set -euo pipefail

      if ! dotnet --list-sdks | grep -q '^10\.'; then
        curl -fsSL https://dot.net/v1/dotnet-install.sh -o /tmp/dotnet-install.sh
        bash /tmp/dotnet-install.sh --channel 10.0 --install-dir "$HOME/.dotnet"
      fi

      export PATH="$HOME/.dotnet:$PATH"
      dotnet --info

      if ! command -v clang >/dev/null 2>&1; then
        sudo apt-get update
        sudo apt-get install -y clang
      fi
      clang --version
      python3 --version

build_script:
  - sh: |
      set -euo pipefail
      export PATH="$HOME/.dotnet:$PATH"
      mkdir -p artifacts/abi

      python3 -m unittest discover -s tools/abi_framework/tests -p "test_*.py"
      PYTHONPATH="tools/abi_codegen_core/src:${PYTHONPATH}" python3 -m unittest discover -s tools/abi_codegen_core/tests -p "test_*.py"
      python3 -m unittest discover -s tools/lumenrtc_codegen/tests -p "test_*.py"

      python3 tools/abi_framework/abi_framework.py validate-plugin-manifest \
        --repo-root . \
        --config abi/config.json

      scripts/abi_guardrails.sh

      python3 tools/abi_framework/abi_framework.py generate \
        --repo-root . \
        --config abi/config.json \
        --skip-binary \
        --check \
        --fail-on-sync \
        --report-json artifacts/abi/generate.report.json

      python3 tools/abi_framework/abi_framework.py codegen \
        --repo-root . \
        --config abi/config.json \
        --skip-binary \
        --check \
        --fail-on-sync \
        --report-json artifacts/abi/codegen.report.json

      dotnet build src/LumenRTC/LumenRTC.csproj -v minimal

      python3 tools/abi_framework/abi_framework.py verify-all \
        --repo-root . \
        --config abi/config.json \
        --skip-binary \
        --output-dir artifacts/abi

      python3 tools/abi_framework/abi_framework.py waiver-audit \
        --config abi/config.json \
        --output artifacts/abi/waiver.audit.report.json \
        --fail-on-expired \
        --fail-on-missing-metadata

artifacts:
  - path: artifacts/abi/**
    name: abi-report

# ABI Governance

## Source of truth

- ABI IDL artifact: `abi/generated/lumenrtc/lumenrtc.idl.json`
- Generated native ABI artifacts:
  - `native/include/lumenrtc.h`
  - `native/lumenrtc.map`
- ABI semantic version macros:
  - `LUMENRTC_ABI_VERSION_MAJOR`
  - `LUMENRTC_ABI_VERSION_MINOR`
  - `LUMENRTC_ABI_VERSION_PATCH`
- Managed interop is generated at C# compile time from ABI IDL by the Roslyn source generator:
  `tools/abi_roslyn_codegen/`
- Project-level managed/native convenience wrappers are generated by LumenRTC-specific
  metadata from:
  `abi/bindings/lumenrtc.managed_api.source.json`
  (normalized metadata: `abi/bindings/lumenrtc.managed_api.json`)
- Runtime resolver and ABI guard logic:
  `src/LumenRTC/Interop/NativeMethods.Core.cs`

## Pipeline

1. Edit/build ABI surface.
2. Fast static verification:
   - `scripts/abi.sh check --skip-binary`
3. Export verification after native build:
   - `scripts/abi.sh check --binary native/build/liblumenrtc.so`
4. Regenerate baseline when ABI change is intentional:
   - `scripts/abi.sh baseline`
5. Multi-target verification:
   - `scripts/abi.sh check-all --skip-binary`
6. Generate ABI IDL from config:
   - `scripts/abi.sh generate --skip-binary`
   - Output: `abi/generated/lumenrtc/lumenrtc.idl.json`
7. Run language generators from ABI IDL (plugin host):
   - `scripts/abi.sh codegen --skip-binary`
   - Includes:
     - `native/src/lumenrtc.exports.cpp`
     - `native/src/lumenrtc_impl.h`
     - `native/src/lumenrtc_impl_handles.generated.h`
8. Generate native ABI artifacts from ABI IDL:
   - `scripts/abi.sh generate --skip-binary`
   - Outputs:
     - `native/include/lumenrtc.h`
     - `native/lumenrtc.map`
9. Build C# project with source generation:
   - `dotnet build src/LumenRTC/LumenRTC.csproj`
   - `src/LumenRTC/LumenRTC.csproj` passes IDL + managed metadata as `AdditionalFiles`
     and receives generated `NativeMethods`, `NativeTypes`, `NativeHandles`, and managed API wrappers in compilation.
10. Sync generated artifacts and optionally baselines:
   - `scripts/abi.sh sync --skip-binary`
11. Benchmark ABI pipeline:
   - `scripts/abi.sh benchmark --skip-binary --iterations 3 --output artifacts/abi/benchmark.report.json`
12. Enforce benchmark budgets:
   - `scripts/abi.sh benchmark-gate --report artifacts/abi/benchmark.report.json --budget abi/benchmark_budget.json`
13. Audit waiver lifecycle and metadata:
   - `scripts/abi.sh waiver-audit --fail-on-expired --fail-on-missing-metadata`
14. Generate ABI changelog:
   - `scripts/abi.sh changelog --skip-binary --release-tag vX.Y.Z --output abi/CHANGELOG.md`
15. Run full release preparation pipeline:
   - `scripts/abi.sh release-prepare --skip-binary --release-tag vX.Y.Z --emit-sbom --emit-attestation`

`native/include/lumenrtc.h` and `native/lumenrtc.map` are generated artifacts.
Do not edit them manually.

## Compatibility policy

- Removing/changing existing ABI symbols is breaking and requires a major bump.
- Adding ABI symbols is additive and requires at least a minor bump.
- Enum value changes/removals are breaking.
- Struct layout changes are breaking by default (`struct_tail_addition_is_breaking`).
- Binary exports must match header ABI symbols.
- Optional bindings symbol policy (`bindings.expected_symbols`) can enforce parity between ABI IDL and language binding expectations.
- Policy rules and waivers are supported (`policy.rules`, `policy.waivers`).
- Waiver governance is policy-driven through `policy.waiver_requirements`.
- For strict mode, waivers should include `created_utc`, `expires_utc`, `owner`, `approved_by`, `ticket`, and `reason`.
- Header parsing uses `header.parser.backend=clang_preprocess` for LumenRTC
  with fallback for local environments; CI validates clang parser is active and
  fallback is not used.
- `header.parser.compiler_candidates` and environment override `ABI_CLANG`
  allow deterministic clang selection on Linux/macOS/Windows.

See also:

- `abi/GOVERNANCE.md`
- `abi/RFC_TEMPLATE.md`

## Reusing for another ABI

`tools/abi_framework` is target-driven. Add another target in `abi/config.json` with:

- header path + API/CALL macros + symbol prefix
- type policy (`enum`/`struct` patterns and exceptions)
- optional `bindings.expected_symbols`
- optional baseline path override
- optional binary export path

Bootstrap command:

- `scripts/abi.sh init-target ...` (or `scripts/abi.ps1 init-target ...`)

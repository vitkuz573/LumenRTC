name: ABI Framework

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "abi/**"
      - "native/include/lumenrtc.h"
      - "src/LumenRTC/Interop/**"
      - "src/LumenRTC/LumenRTC.csproj"
      - "tools/abi_framework/**"
      - "tools/abi_codegen_core/**"
      - "tools/lumenrtc_codegen/**"
      - "tools/abi_roslyn_codegen/**"
      - "scripts/abi_guardrails.sh"
      - "scripts/abi.sh"
      - "scripts/abi.ps1"
  push:
    branches:
      - main
    paths:
      - "abi/**"
      - "native/include/lumenrtc.h"
      - "src/LumenRTC/Interop/**"
      - "src/LumenRTC/LumenRTC.csproj"
      - "tools/abi_framework/**"
      - "tools/abi_codegen_core/**"
      - "tools/lumenrtc_codegen/**"
      - "tools/abi_roslyn_codegen/**"
      - "scripts/abi_guardrails.sh"
      - "scripts/abi.sh"
      - "scripts/abi.ps1"

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Ensure clang is available
        run: |
          if ! command -v clang >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y clang
          fi
          clang --version

      - name: Unit tests (abi_framework)
        run: |
          python3 -m unittest discover -s tools/abi_framework/tests -p "test_*.py"

      - name: Unit tests (abi_codegen_core)
        run: |
          PYTHONPATH="tools/abi_codegen_core/src:${PYTHONPATH}" \
          python3 -m unittest discover -s tools/abi_codegen_core/tests -p "test_*.py"

      - name: Unit tests (lumenrtc_codegen)
        run: |
          python3 -m unittest discover -s tools/lumenrtc_codegen/tests -p "test_*.py"

      - name: Validate plugin manifests
        run: |
          python3 tools/abi_framework/abi_framework.py validate-plugin-manifest \
            --repo-root . \
            --config abi/config.json

      - name: Enforce generation guardrails
        run: |
          scripts/abi_guardrails.sh

      - name: Check generated ABI artifacts
        run: |
          mkdir -p artifacts/abi
          python3 tools/abi_framework/abi_framework.py generate \
            --repo-root . \
            --config abi/config.json \
            --skip-binary \
            --check \
            --fail-on-sync \
            --report-json artifacts/abi/generate.report.json

      - name: Check configured ABI generators
        run: |
          python3 tools/abi_framework/abi_framework.py codegen \
            --repo-root . \
            --config abi/config.json \
            --skip-binary \
            --check \
            --fail-on-sync \
            --report-json artifacts/abi/codegen.report.json

      - name: Validate C# source generator integration
        run: |
          dotnet build src/LumenRTC/LumenRTC.csproj -v minimal

      - name: Verify ABI Targets
        run: |
          python3 tools/abi_framework/abi_framework.py verify-all \
            --repo-root . \
            --config abi/config.json \
            --skip-binary \
            --output-dir artifacts/abi

      - name: Audit waivers
        run: |
          python3 tools/abi_framework/abi_framework.py waiver-audit \
            --config abi/config.json \
            --output artifacts/abi/waiver.audit.report.json \
            --fail-on-expired \
            --fail-on-missing-metadata

      - name: Assert clang parser backend active
        run: |
          python3 tools/abi_framework/abi_framework.py snapshot \
            --repo-root . \
            --config abi/config.json \
            --target lumenrtc \
            --skip-binary \
            --output artifacts/abi/lumenrtc.snapshot.json
          python3 - <<'PY'
          import json
          path = "artifacts/abi/lumenrtc.snapshot.json"
          with open(path, "r", encoding="utf-8") as fh:
              snapshot = json.load(fh)
          parser = ((snapshot.get("header") or {}).get("parser") or {})
          requested = parser.get("backend_requested")
          backend = parser.get("backend")
          fallback_used = bool(parser.get("fallback_used"))
          details = parser.get("details") or {}
          compiler_resolved = details.get("compiler_resolved")
          if requested != "clang_preprocess":
              raise SystemExit(f"expected backend_requested=clang_preprocess, got: {requested!r}")
          if backend != "clang_preprocess" or fallback_used:
              raise SystemExit(
                  "clang parser backend is not active without fallback: "
                  f"backend={backend!r}, fallback_used={fallback_used}"
              )
          if not isinstance(compiler_resolved, str) or not compiler_resolved.strip():
              raise SystemExit(f"clang parser metadata is missing compiler_resolved: {details!r}")
          print("clang parser backend is active and fallback is not used")
          PY

      - name: Benchmark ABI pipeline
        run: |
          python3 tools/abi_framework/abi_framework.py benchmark \
            --repo-root . \
            --config abi/config.json \
            --skip-binary \
            --iterations 2 \
            --output artifacts/abi/benchmark.report.json

      - name: Enforce benchmark budget
        run: |
          python3 tools/abi_framework/abi_framework.py benchmark-gate \
            --report artifacts/abi/benchmark.report.json \
            --budget abi/benchmark_budget.json \
            --output artifacts/abi/benchmark.gate.report.json

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: artifacts/abi/aggregate.report.sarif.json

      - name: Upload ABI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: abi-report
          path: artifacts/abi/**
